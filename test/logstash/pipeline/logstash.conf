input {
	file {
		path => "/usr/share/logstash/input_data/address.csv"
		type => "poi"
		start_position => "beginning"
		sincedb_path => "/usr/share/logstash/sincedb/poi.file"
	}
	file {
		path => "/usr/share/logstash/input_data/address.csv"
		type => "address"
		start_position => "beginning"
		sincedb_path => "/usr/share/logstash/sincedb/address.file"
	}
}

filter {
	if [type] == "address" {
		csv {
			separator => ","
			columns => ["poi_id","poi_code","fname","cname","phone_a","phone_b","phone_c","zip_code","address","san_bun","primary_bun","secondary_bun","longitude","latitude"]
			remove_field => ["fname","cname","phone_a","phone_b","phone_c","zip_code","longitude","latitude"]
		}
		ruby {
			code => '
				split_address = event.get("address").split(" ")
				value = split_address
				value = value << split_address[1] + " " + split_address[2]
				value = value << event.get("address")
				value = value << split_address[1] + " " + split_address[2] + " " + event.get("primary_bun")
				value = value << split_address[1] + " " + split_address[2] + " " + event.get("primary_bun") + "-"\
				+ event.get("secondary_bun")
				value = value << event.get("address") + " " + event.get("primary_bun")
				value = value << event.get("address") + " " + event.get("primary_bun") + "-" + event.get("secondary_bun")
				value = value << event.get("primary_bun") + "-" + event.get("secondary_bun")
				event.set("[address_suggest][input]", value)
			'
		}
	}
	else if [type] == "poi" {
		csv {
			separator =>","
			skip_header => false
			columns => ["poi_id","poi_code","fname","cname","phone_a","phone_b","phone_c","zip_code","address","san_bun","primary_bun","secondary_bun","longitude","latitude"]
			remove_field =>["address","san_bun","primary_bun","secondary_bun"]
		}
		mutate {
			gsub => ["phone_a", "NULL", "-1"]
			gsub => ["phone_b", "NULL", "-1"]
			gsub => ["phone_c", "NULL", "-1"]
			gsub => ["zip_code", "NULL", "-1"]
			rename => {"[longitude]" => "[location][lon]"}
			rename => {"[latitude]" => "[location][lat]"}
		}
		translate {
			target => "[@metadata][match]"
			dictionary_path => "/usr/share/logstash/input_data/category_dic.csv"
			source => "poi_code"
		}
		dissect {
			mapping => {"[@metadata][match]" => "%{large_category};%{medium_category};%{small_category}"}
		}
		
		ruby {
			code => '
				split_category = event.get("[@metadata][match]").split(";")
				event.set("[large_category]",split_category[0])
				event.set("[medium_category]",split_category[1])
				event.set("[small_category]",split_category[2])
				combined_name = [event.get("fname") + " " + event.get("cname")]
				combined_name = combined_name << event.get("cname")
				event.set("[poi_suggest][input]", combined_name)
			'
		}
	}
}

output {
	if [type] == "address" {
		elasticsearch {
			hosts => ["http://cluster1-master-node:9200"]
			index => "address"
		}
	}
	if [type] == "poi" {
		elasticsearch {
			hosts => ["http://cluster1-master-node:9200"]
			index => "poi"
		}
	}
	stdout {codec => rubydebug {metadata => true}}
}
